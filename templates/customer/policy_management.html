{% extends "base.html" %}

{% block title %}Policy Management - ClearView Insurance{% endblock %}

{% block content %}
<div class="container-fluid py-4">
	<div class="row">
		<!-- Sidebar -->
		<aside class="col-12 col-md-3 col-lg-2 mb-4 mb-md-0">
			<div class="dashboard-sidebar p-3 bg-light rounded shadow-sm">
				<h6 class="text-uppercase text-muted mb-3">User Options</h6>
				<div class="d-grid gap-2">
					<a class="btn btn-outline-primary sidebar-btn" href="{{ url_for('customer_dashboard') }}">
						<i class="bi bi-house"></i> Dashboard
					</a>
					<a class="btn btn-outline-primary sidebar-btn" href="{{ url_for('customer_search') }}">
						<i class="bi bi-search"></i> Search
					</a>
					<a class="btn btn-primary sidebar-btn" href="{{ url_for('customer_policy_management') }}">
						<i class="bi bi-shield-check"></i> Policy Management
					</a>
					<a class="btn btn-outline-primary sidebar-btn" href="{{ url_for('customer_search_vehicle') }}">
						<i class="bi bi-car-front"></i> Search Vehicle
					</a>
					<a class="btn btn-outline-primary sidebar-btn" href="{{ url_for('customer_reports_and_insights') }}">
						<i class="bi bi-graph-up"></i> Reports & Insights
					</a>
				</div>
			</div>
		</aside>

		<!-- Main content -->
		<main class="col-12 col-md-9 col-lg-10">
			<div class="px-2 px-md-3">
				<!-- Header -->
				<div class="d-flex justify-content-between align-items-center mb-4">
					<div>
						<h2><i class="bi bi-shield-check"></i> Policy Management</h2>
						<p class="text-muted mb-0">Manage your policies and monitoring</p>
					</div>
					<div>
						<a href="{{ url_for('customer_search_policy') }}" class="btn btn-primary">
							<i class="bi bi-search"></i> Search Policy
						</a>
					</div>
				</div>

				<!-- Pending Requests Summary -->
				{% if access_requests or cancellation_requests or renewal_requests %}
				<div class="alert alert-info mb-4">
					<h5 class="alert-heading"><i class="bi bi-clock-history"></i> Pending Requests</h5>
					<p class="mb-0">
						{% if access_requests %}<span class="badge bg-primary me-2">{{ access_requests|length }} Access Request(s)</span>{% endif %}
						{% if cancellation_requests %}<span class="badge bg-warning text-dark me-2">{{ cancellation_requests|length }} Cancellation Request(s)</span>{% endif %}
						{% if renewal_requests %}<span class="badge bg-success me-2">{{ renewal_requests|length }} Renewal Request(s)</span>{% endif %}
					</p>
				</div>
				{% endif %}

				<!-- My Policies -->
				<div class="card shadow-sm mb-4">
					<div class="card-header bg-primary text-white">
						<h5 class="mb-0"><i class="bi bi-shield-fill-check"></i> My Policies ({{ owned_policies|length }})</h5>
					</div>
					<div class="card-body">
						{% if owned_policies %}
						<div class="table-responsive">
							<table class="table table-hover mb-0">
								<thead>
									<tr>
										<th>Policy Number</th>
										<th>Vehicle</th>
										<th>Insurance Company</th>
										<th>Type</th>
										<th>Status</th>
										<th>Expiry Date</th>
										<th>Actions</th>
									</tr>
								</thead>
								<tbody>
									{% for policy in owned_policies %}
									<tr>
										<td><strong>{{ policy.policy_number }}</strong></td>
										<td>
											{{ policy.registration_number }}<br>
											<small class="text-muted">{{ policy.make_model }}</small>
										</td>
										<td>{{ policy.insurance_company.name if policy.insurance_company else 'N/A' }}</td>
										<td>{{ policy.policy_type }}</td>
										<td>
											{% if policy.status == 'Active' %}
												<span class="badge bg-success">{{ policy.status }}</span>
											{% elif policy.status == 'Expired' %}
												<span class="badge bg-secondary">{{ policy.status }}</span>
											{% else %}
												<span class="badge bg-danger">{{ policy.status }}</span>
											{% endif %}
										</td>
										<td>
											{{ policy.expiry_date.strftime('%d %b %Y') if policy.expiry_date else 'N/A' }}
											{% set days_left = (policy.expiry_date - today).days if policy.expiry_date else None %}
											{% if days_left is not none and days_left <= 30 and days_left >= 0 %}
												<br><small class="text-warning">{{ days_left }} days left</small>
											{% endif %}
										</td>
										<td>
											<div class="btn-group btn-group-sm">
												<a href="{{ url_for('customer_view_policy_from_management', policy_id=policy.id) }}" 
												   class="btn btn-outline-primary" title="View Details">
													<i class="bi bi-eye"></i>
												</a>
												{% set days_left = (policy.expiry_date - today).days if policy.expiry_date else None %}
												{% if policy.status == 'Active' and days_left is not none and days_left <= 30 %}
													<a href="{{ url_for('customer_request_renewal', policy_id=policy.id) }}" 
													   class="btn btn-outline-success" title="Request Renewal">
														<i class="bi bi-arrow-clockwise"></i>
													</a>
												{% endif %}
												{% if policy.status == 'Active' %}
													<a href="{{ url_for('customer_request_cancellation', policy_id=policy.id) }}" 
													   class="btn btn-outline-danger" title="Request Cancellation">
														<i class="bi bi-x-circle"></i>
													</a>
												{% endif %}
											</div>
										</td>
									</tr>
									{% endfor %}
								</tbody>
							</table>
						</div>
						{% else %}
						<div class="text-center py-4">
							<i class="bi bi-inbox text-muted" style="font-size: 3rem;"></i>
							<p class="text-muted mt-2">No policies in your account</p>
							<a href="{{ url_for('customer_search_policy') }}" class="btn btn-primary">
								<i class="bi bi-search"></i> Search for Policies
							</a>
						</div>
						{% endif %}
					</div>
				</div>

				<!-- Monitored Policies -->
				<div class="card shadow-sm mb-4">
					<div class="card-header bg-info text-white">
						<h5 class="mb-0"><i class="bi bi-eye"></i> Monitored Policies ({{ monitored_policies|length }})</h5>
					</div>
					<div class="card-body">
						{% if monitored_policies %}
						<div class="table-responsive">
							<table class="table table-hover mb-0">
								<thead>
									<tr>
										<th>Policy Number</th>
										<th>Vehicle</th>
										<th>Insurance Company</th>
										<th>Type</th>
										<th>Status</th>
										<th>Expiry Date</th>
										<th>Actions</th>
									</tr>
								</thead>
								<tbody>
									{% for policy in monitored_policies %}
									<tr>
										<td><strong>{{ policy.policy_number }}</strong></td>
										<td>
											{{ policy.registration_number }}<br>
											<small class="text-muted">{{ policy.make_model }}</small>
										</td>
										<td>{{ policy.insurance_company.name if policy.insurance_company else 'N/A' }}</td>
										<td>{{ policy.policy_type }}</td>
										<td>
											{% if policy.status == 'Active' %}
												<span class="badge bg-success">{{ policy.status }}</span>
											{% elif policy.status == 'Expired' %}
												<span class="badge bg-secondary">{{ policy.status }}</span>
											{% else %}
												<span class="badge bg-danger">{{ policy.status }}</span>
											{% endif %}
										</td>
										<td>{{ policy.expiry_date.strftime('%d %b %Y') if policy.expiry_date else 'N/A' }}</td>
										<td>
											<div class="btn-group btn-group-sm">
												<a href="{{ url_for('customer_view_policy_from_management', policy_id=policy.id) }}" 
												   class="btn btn-outline-primary" title="View Details">
													<i class="bi bi-eye"></i>
												</a>
												<form action="{{ url_for('customer_remove_from_monitor', policy_id=policy.id) }}" 
													  method="POST" style="display: inline;">
													<button type="submit" class="btn btn-outline-danger btn-sm" title="Remove from Monitoring"
															onclick="return confirm('Remove this policy from monitoring?')">
														<i class="bi bi-trash"></i>
													</button>
												</form>
											</div>
										</td>
									</tr>
									{% endfor %}
								</tbody>
							</table>
						</div>
						{% else %}
						<div class="text-center py-4">
							<i class="bi bi-eye-slash text-muted" style="font-size: 3rem;"></i>
							<p class="text-muted mt-2">No monitored policies</p>
							<small class="text-muted">Search for policies and add them to monitoring to track their status</small>
						</div>
						{% endif %}
					</div>
				</div>
			</div>
		</main>
	</div>
</div>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">

<script>
// Pass today's date from backend
const today = new Date('{{ today }}');
</script>
{% endblock %}
