{% extends 'base.html' %}
{% block content %}
<div class="container-fluid py-4">
	<div class="row">
		<!-- Sidebar -->
		<aside class="col-12 col-md-3 col-lg-2 mb-4 mb-md-0">
			<div class="dashboard-sidebar p-3 bg-light rounded shadow-sm">
				<h6 class="text-uppercase text-muted mb-3">User Options</h6>
				<div class="d-grid gap-2">
					<a class="btn btn-success sidebar-btn" href="{{ url_for('customer_ai_analytics') }}">
						<i class="bi bi-robot"></i> AI Analytics
					</a>
					<a class="btn btn-primary sidebar-btn" href="{{ url_for('customer_search') }}">
						<i class="bi bi-search"></i> Search
					</a>
					<a class="btn btn-outline-primary sidebar-btn" href="{{ url_for('customer_policy_management') }}">
						<i class="bi bi-shield-check"></i> Policy Management
					</a>
				<a class="btn btn-outline-primary sidebar-btn" href="#">Claims Management</a>
				<a class="btn btn-outline-primary sidebar-btn" href="{{ url_for('customer_search_vehicle') }}">Search Vehicle</a>
				<a class="btn btn-outline-primary sidebar-btn" href="{{ url_for('customer_reports_and_insights') }}">Reports & Insights</a>
				</div>
			</div>
		</aside>

		<!-- Main content -->
		<main class="col-12 col-md-9 col-lg-10">
			<div class="px-2 px-md-3">
				<h3 class="fw-bold mb-2">Welcome, {{ current_user.username }}!</h3>
				<h5 class="text-muted mb-3">Your Insurance Dashboard</h5>

				<!-- Pending Requests Alert -->
				{% if total_pending_requests > 0 %}
				<div class="alert alert-info alert-dismissible fade show mb-4" role="alert">
					<i class="bi bi-clock-history"></i> You have <strong>{{ total_pending_requests }}</strong> pending request(s).
					<a href="{{ url_for('customer_policy_management') }}" class="alert-link">View details</a>
					<button type="button" class="btn-close" data-bs-dismiss="alert"></button>
				</div>
				{% endif %}

				<!-- Expiring Soon Alert -->
				{% if expiring_soon_count > 0 %}
				<div class="alert alert-warning alert-dismissible fade show mb-4" role="alert">
					<i class="bi bi-exclamation-triangle"></i> You have <strong>{{ expiring_soon_count }}</strong> policy/policies expiring within 30 days.
					<a href="{{ url_for('customer_policy_management') }}" class="alert-link">Manage policies</a>
					<button type="button" class="btn-close" data-bs-dismiss="alert"></button>
				</div>
				{% endif %}

				<!-- Summary Tables -->
				<div class="row g-3 mb-4">
					<!-- Owned Policies Table -->
					<div class="col-12 col-lg-6">
						<div class="card shadow-sm h-100">
							<div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
								<h6 class="mb-0"><i class="bi bi-shield-check"></i> My Policies</h6>
								<a href="{{ url_for('customer_policy_management') }}" class="btn btn-sm btn-light">View All</a>
							</div>
							<div class="card-body p-0">
								{% if owned_policies %}
									<div class="table-responsive">
										<table class="table table-sm table-hover mb-0 align-middle">
											<thead class="table-light">
												<tr>
													<th>Policy Number</th>
													<th>Vehicle</th>
													<th>Type</th>
													<th>Expires</th>
													<th>Status</th>
												</tr>
											</thead>
											<tbody>
												{% for policy in owned_policies %}
													{% set days_to_expiry = (policy.expiry_date - now.date()).days if policy.expiry_date else None %}
													<tr>
														<td>
															<a href="{{ url_for('customer_view_policy_from_management', policy_id=policy.id) }}" 
															   class="text-primary text-decoration-none">
																{{ policy.policy_number }}
															</a>
														</td>
														<td>
															<small>{{ policy.registration_number }}</small><br>
															<small class="text-muted">{{ policy.make_model }}</small>
														</td>
														<td>
															{% if policy.policy_type == 'Comprehensive' %}
																<span class="badge bg-primary">Comp</span>
															{% elif policy.policy_type == 'Third Party' %}
																<span class="badge bg-secondary">TP</span>
															{% else %}
																<span class="badge bg-info">{{ policy.policy_type[:4] }}</span>
															{% endif %}
														</td>
														<td>
															{% if policy.expiry_date %}
																<small>{{ policy.expiry_date.strftime('%d %b %Y') }}</small>
																{% if days_to_expiry is not none %}
																	{% if days_to_expiry < 0 %}
																		<br><small class="text-danger">(Expired)</small>
																	{% elif days_to_expiry <= 30 %}
																		<br><small class="text-warning">({{ days_to_expiry }} days)</small>
																	{% endif %}
																{% endif %}
															{% else %}
																<small class="text-muted">N/A</small>
															{% endif %}
														</td>
														<td>
															{% if policy.status == 'Active' %}
																{% if days_to_expiry is not none and days_to_expiry >= 0 %}
																	<span class="badge bg-success">Active</span>
																{% else %}
																	<span class="badge bg-danger">Expired</span>
																{% endif %}
															{% elif policy.status == 'Cancelled' %}
																<span class="badge bg-dark">Cancelled</span>
															{% else %}
																<span class="badge bg-secondary">{{ policy.status }}</span>
															{% endif %}
														</td>
													</tr>
												{% endfor %}
											</tbody>
										</table>
									</div>
								{% else %}
									<div class="text-center py-4">
										<i class="bi bi-shield-x text-muted" style="font-size: 2rem;"></i>
										<p class="text-muted mt-2 mb-0">No policies found</p>
										<a href="{{ url_for('customer_policy_management') }}" class="btn btn-sm btn-primary mt-2">
											<i class="bi bi-plus-circle"></i> Add Policy
										</a>
									</div>
								{% endif %}
							</div>
						</div>
					</div>

					<!-- Recent Claims Table -->
					<div class="col-12 col-lg-6">
						<div class="card shadow-sm h-100">
							<div class="card-header bg-warning text-dark d-flex justify-content-between align-items-center">
								<h6 class="mb-0"><i class="bi bi-file-earmark-medical"></i> Recent Claims</h6>
								<a href="{{ url_for('customer_search') }}" class="btn btn-sm btn-dark">View All</a>
							</div>
							<div class="card-body p-0">
								{% if recent_claims %}
									<div class="table-responsive">
										<table class="table table-sm table-hover mb-0 align-middle">
											<thead class="table-light">
												<tr>
													<th>Claim Number</th>
													<th>Policy</th>
													<th>Accident Date</th>
													<th>Status</th>
												</tr>
											</thead>
											<tbody>
												{% for claim in recent_claims %}
													<tr>
														<td>
															<a href="{{ url_for('customer_view_claim_detail', claim_id=claim.id) }}" 
															   class="text-warning text-decoration-none">
																{{ claim.claim_number }}
															</a>
														</td>
														<td>
															<small>{{ claim.policy.policy_number }}</small>
														</td>
														<td><small>{{ claim.accident_date.strftime('%d %b %Y') if claim.accident_date else 'N/A' }}</small></td>
														<td>
															{% if claim.status == 'Pending' %}
																<span class="badge bg-warning text-dark">Pending</span>
															{% elif claim.status == 'Under Review' %}
																<span class="badge bg-info">Review</span>
															{% elif claim.status == 'Approved' %}
																<span class="badge bg-success">Approved</span>
															{% elif claim.status == 'Rejected' %}
																<span class="badge bg-danger">Rejected</span>
															{% else %}
																<span class="badge bg-secondary">{{ claim.status }}</span>
															{% endif %}
														</td>
													</tr>
												{% endfor %}
											</tbody>
										</table>
									</div>
								{% else %}
									<div class="text-center py-4">
										<i class="bi bi-inbox text-muted" style="font-size: 2rem;"></i>
										<p class="text-muted mt-2 mb-0">No claims filed yet</p>
									</div>
								{% endif %}
							</div>
						</div>
					</div>
				</div>

				<!-- Metrics row -->
				<div class="row g-3">
					<div class="col-6 col-md-3">
						<div class="metric-card text-center shadow-sm p-3 bg-white rounded h-100">
							<i class="bi bi-shield-check text-primary" style="font-size: 2rem;"></i>
							<p class="text-muted mb-1 small mt-2">Total Policies</p>
							<p class="metric-value text-primary mb-0 fs-3 fw-bold">{{ total_policies }}</p>
						</div>
					</div>
					<div class="col-6 col-md-3">
						<div class="metric-card text-center shadow-sm p-3 bg-white rounded h-100">
							<i class="bi bi-shield-fill-check text-success" style="font-size: 2rem;"></i>
							<p class="text-muted mb-1 small mt-2">Active Policies</p>
							<p class="metric-value text-success mb-0 fs-3 fw-bold">{{ active_policies }}</p>
						</div>
					</div>
					<div class="col-6 col-md-3">
						<div class="metric-card text-center shadow-sm p-3 bg-white rounded h-100">
							<i class="bi bi-file-earmark-medical text-warning" style="font-size: 2rem;"></i>
							<p class="text-muted mb-1 small mt-2">Total Claims</p>
							<p class="metric-value text-warning mb-0 fs-3 fw-bold">{{ total_claims }}</p>
						</div>
					</div>
					<div class="col-6 col-md-3">
						<div class="metric-card text-center shadow-sm p-3 bg-white rounded h-100">
							<i class="bi bi-currency-exchange text-info" style="font-size: 2rem;"></i>
							<p class="text-muted mb-1 small mt-2">Total Premium</p>
							<p class="metric-value text-info mb-0 fs-6 fw-bold">KES {{ "{:,.0f}".format(total_premium) }}</p>
						</div>
					</div>
				</div>
			</div>
		</main>
	</div>
</div>
{% endblock %}
