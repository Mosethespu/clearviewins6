{% extends "base.html" %}

{% block title %}Policy Details - {{ policy.policy_number }} - ClearView Insurance{% endblock %}

{% block content %}
<div class="container-fluid py-4">
	<div class="row">
		<!-- Sidebar -->
		<aside class="col-12 col-md-3 col-lg-2 mb-4 mb-md-0">
			<div class="dashboard-sidebar p-3 bg-light rounded shadow-sm">
				<h6 class="text-uppercase text-muted mb-3">User Options</h6>
				<div class="d-grid gap-2">
					<a class="btn btn-outline-primary sidebar-btn" href="{{ url_for('customer_dashboard') }}">
						<i class="bi bi-house"></i> Dashboard
					</a>
					<a class="btn btn-outline-primary sidebar-btn" href="{{ url_for('customer_search') }}">
						<i class="bi bi-search"></i> Search
					</a>
					<a class="btn btn-primary sidebar-btn" href="{{ url_for('customer_policy_management') }}">
						<i class="bi bi-shield-check"></i> Policy Management
					</a>
					<a class="btn btn-outline-primary sidebar-btn" href="{{ url_for('customer_search_vehicle') }}">
						<i class="bi bi-car-front"></i> Search Vehicle
					</a>
					<a class="btn btn-outline-primary sidebar-btn" href="{{ url_for('customer_reports_and_insights') }}">
						<i class="bi bi-graph-up"></i> Reports & Insights
					</a>
				</div>
			</div>
		</aside>

		<!-- Main content -->
		<main class="col-12 col-md-9 col-lg-10">
			<div class="px-2 px-md-3">
				<!-- Header -->
				<div class="d-flex justify-content-between align-items-center mb-4">
					<div>
						<h2><i class="bi bi-file-text-fill"></i> Policy Details</h2>
						<p class="text-muted mb-0">{{ policy.policy_number }}
							{% if is_owner %}
								<span class="badge bg-success ms-2">Your Policy</span>
							{% elif is_monitored %}
								<span class="badge bg-info ms-2">Monitoring</span>
							{% endif %}
						</p>
					</div>
					<div>
						<a href="{{ url_for('customer_policy_management') }}" 
						   class="btn btn-outline-secondary">
							<i class="bi bi-arrow-left"></i> Back to Management
						</a>
					</div>
				</div>

				<!-- Action Buttons for Owners -->
				{% if is_owner %}
				<div class="card shadow-sm mb-4 border-success">
					<div class="card-header bg-success text-white">
						<h5 class="mb-0"><i class="bi bi-hand-pointer"></i> Policy Actions</h5>
					</div>
					<div class="card-body">
						<div class="row g-2">
							{% if can_renew and not has_renewal_request %}
							<div class="col-md-4">
								<a href="{{ url_for('customer_request_renewal', policy_id=policy.id) }}" class="btn btn-success w-100">
									<i class="bi bi-arrow-clockwise"></i> Request Renewal
									{% if days_until_expiry is not none %}
										<br><small>({{ days_until_expiry }} days until expiry)</small>
									{% endif %}
								</a>
							</div>
							{% elif has_renewal_request %}
							<div class="col-md-4">
								<button class="btn btn-outline-success w-100" disabled>
									<i class="bi bi-hourglass-split"></i> Renewal Pending
								</button>
							</div>
							{% endif %}
							
							{% if policy.status == 'Active' and not has_cancellation_request %}
							<div class="col-md-4">
								<a href="{{ url_for('customer_request_cancellation', policy_id=policy.id) }}" class="btn btn-danger w-100">
									<i class="bi bi-x-circle"></i> Request Cancellation
								</a>
							</div>
							{% elif has_cancellation_request %}
							<div class="col-md-4">
								<button class="btn btn-outline-danger w-100" disabled>
									<i class="bi bi-hourglass-split"></i> Cancellation Pending
								</button>
							</div>
							{% endif %}
						</div>
					</div>
				</div>
				{% endif %}

				<!-- Policy Status Banner -->
				<div class="alert {% if policy.status == 'Active' %}alert-success{% elif policy.status == 'Expired' %}alert-secondary{% else %}alert-danger{% endif %} mb-4">
					<div class="d-flex justify-content-between align-items-center">
						<div>
							<h5 class="mb-0">
								<i class="bi {% if policy.status == 'Active' %}bi-check-circle{% elif policy.status == 'Expired' %}bi-x-circle{% else %}bi-exclamation-circle{% endif %}"></i>
								Policy Status: <strong>{{ policy.status }}</strong>
							</h5>
						</div>
						<div>
							<strong>Policy Number:</strong> {{ policy.policy_number }}
						</div>
					</div>
				</div>

				<!-- Vehicle Information -->
				<div class="card shadow-sm mb-4">
					<div class="card-header bg-primary text-white">
						<h5 class="mb-0"><i class="bi bi-car-front"></i> Vehicle Information</h5>
					</div>
					<div class="card-body">
						<div class="row">
							<div class="col-md-6">
								<table class="table table-borderless mb-0">
									<tr>
										<th class="text-muted" style="width: 45%;">Registration Number:</th>
										<td><strong>{{ policy.registration_number }}</strong></td>
									</tr>
									<tr>
										<th class="text-muted">Make & Model:</th>
										<td><strong>{{ policy.make_model }}</strong></td>
									</tr>
									<tr>
										<th class="text-muted">Year of Manufacture:</th>
										<td>{{ policy.year_of_manufacture }}</td>
									</tr>
									<tr>
										<th class="text-muted">Chassis Number:</th>
										<td><code>{{ policy.chassis_number }}</code></td>
									</tr>
									<tr>
										<th class="text-muted">Engine Number:</th>
										<td><code>{{ policy.engine_number }}</code></td>
									</tr>
								</table>
							</div>
							<div class="col-md-6">
								<table class="table table-borderless mb-0">
									<tr>
										<th class="text-muted" style="width: 45%;">Body Type:</th>
										<td>{{ policy.body_type }}</td>
									</tr>
									<tr>
										<th class="text-muted">Color:</th>
										<td>{{ policy.color }}</td>
									</tr>
									<tr>
										<th class="text-muted">Seating Capacity:</th>
										<td>{{ policy.seating_capacity }} seats</td>
									</tr>
									<tr>
										<th class="text-muted">Use Category:</th>
										<td>{{ policy.use_category }}</td>
									</tr>
								</table>
							</div>
						</div>
					</div>
				</div>

				<!-- Policy Details -->
				<div class="card shadow-sm mb-4">
					<div class="card-header bg-success text-white">
						<h5 class="mb-0"><i class="bi bi-shield-check"></i> Coverage Information</h5>
					</div>
					<div class="card-body">
						<div class="row">
							<div class="col-md-6">
								<table class="table table-borderless mb-0">
									<tr>
										<th class="text-muted" style="width: 45%;">Policy Type:</th>
										<td><strong>{{ policy.policy_type }}</strong></td>
									</tr>
									<tr>
										<th class="text-muted">Insurance Company:</th>
										<td><strong>{{ policy.insurance_company.name if policy.insurance_company else 'N/A' }}</strong></td>
									</tr>
									<tr>
										<th class="text-muted">Effective Date:</th>
										<td>{{ policy.effective_date.strftime('%d %B %Y') if policy.effective_date else 'N/A' }}</td>
									</tr>
									<tr>
										<th class="text-muted">Expiry Date:</th>
										<td>{{ policy.expiry_date.strftime('%d %B %Y') if policy.expiry_date else 'N/A' }}
											{% if days_until_expiry is not none and days_until_expiry >= 0 %}
												<br><small class="{% if days_until_expiry <= 30 %}text-warning{% else %}text-muted{% endif %}">
													({{ days_until_expiry }} days remaining)
												</small>
											{% endif %}
										</td>
									</tr>
									<tr>
										<th class="text-muted">Premium Amount:</th>
										<td><strong class="text-success">KES {{ "{:,.2f}".format(policy.premium_amount) if policy.premium_amount else '0.00' }}</strong></td>
									</tr>
								</table>
							</div>
							<div class="col-md-6">
								<table class="table table-borderless mb-0">
									<tr>
										<th class="text-muted" style="width: 45%;">Sum Insured:</th>
										<td><strong>KES {{ "{:,.2f}".format(policy.sum_insured) if policy.sum_insured else '0.00' }}</strong></td>
									</tr>
									<tr>
										<th class="text-muted">Excess:</th>
										<td>KES {{ "{:,.2f}".format(policy.excess) if policy.excess else '0.00' }}</td>
									</tr>
									<tr>
										<th class="text-muted">Payment Mode:</th>
										<td>{{ policy.payment_mode }}</td>
									</tr>
									<tr>
										<th class="text-muted">Date Entered:</th>
										<td>{{ policy.date_entered.strftime('%d %B %Y') if policy.date_entered else 'N/A' }}</td>
									</tr>
								</table>
							</div>
						</div>

						<!-- Additional Coverage -->
						<hr>
						<h6 class="mb-3"><i class="bi bi-plus-circle"></i> Additional Coverage</h6>
						<div class="row">
							<div class="col-md-6">
								<ul class="list-unstyled">
									<li>
										<i class="bi {% if policy.political_violence %}bi-check-circle-fill text-success{% else %}bi-x-circle text-muted{% endif %}"></i>
										Political Violence & Terrorism
									</li>
									<li>
										<i class="bi {% if policy.windscreen_cover %}bi-check-circle-fill text-success{% else %}bi-x-circle text-muted{% endif %}"></i>
										Windscreen Cover
									</li>
								</ul>
							</div>
							<div class="col-md-6">
								<ul class="list-unstyled">
									<li>
										<i class="bi {% if policy.passenger_liability %}bi-check-circle-fill text-success{% else %}bi-x-circle text-muted{% endif %}"></i>
										Passenger Liability
									</li>
									<li>
										<i class="bi {% if policy.road_rescue %}bi-check-circle-fill text-success{% else %}bi-x-circle text-muted{% endif %}"></i>
										Road Rescue Services
									</li>
								</ul>
							</div>
						</div>
					</div>
				</div>

				<!-- Vehicle Photos -->
				{% if policy.photos %}
				<div class="card shadow-sm mb-4">
					<div class="card-header bg-info text-white">
						<h5 class="mb-0"><i class="bi bi-images"></i> Vehicle Photos</h5>
					</div>
					<div class="card-body">
						<div class="row g-3">
						{% for photo in policy.photos %}
						<div class="col-md-4 col-lg-3">
							<div class="card">
								<img src="/uploads/{{ photo.file_path }}" 
									 class="card-img-top" 
									 alt="{{ photo.photo_type }}"
									 style="height: 200px; object-fit: cover;"
									 onerror="this.style.display='none'">
								<div class="card-body text-center">
									<p class="mb-0 small text-muted">{{ photo.photo_type.replace('_', ' ').title() }}</p>
								</div>
							</div>
						</div>
						{% endfor %}
						</div>
					</div>
				</div>
				{% else %}
				<div class="card shadow-sm mb-4">
					<div class="card-body text-center py-4">
						<i class="bi bi-images text-muted" style="font-size: 3rem;"></i>
						<p class="text-muted mt-2 mb-0">No vehicle photos available for this policy</p>
					</div>
				</div>
				{% endif %}
			</div>
		</main>
	</div>
</div>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
{% endblock %}
