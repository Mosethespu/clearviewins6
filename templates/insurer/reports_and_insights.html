{% extends "base.html" %}

{% block title %}Reports & Insights - ClearView Insurance{% endblock %}

{% block content %}
<div class="container-fluid py-4">
	<!-- Header -->
	<div class="row mb-4">
		<div class="col-md-6">
			<h2><i class="bi bi-graph-up"></i> Reports & Insights</h2>
			<p class="text-muted">Comprehensive analytics for {{ user_company.name }}</p>
		</div>
		<div class="col-md-6 text-end">
			<a href="{{ url_for('insurer_dashboard') }}" class="btn btn-outline-secondary">
				<i class="bi bi-house"></i> Dashboard
			</a>
		</div>
	</div>

	<!-- Company Performance Summary -->
	<div class="row mb-4">
		<div class="col-12">
			<div class="card shadow-sm border-primary">
				<div class="card-header bg-primary text-white">
					<h4 class="mb-0"><i class="bi bi-building"></i> {{ user_company.name }} - Performance Summary</h4>
				</div>
				<div class="card-body">
					<div class="row g-3">
						<!-- Policies Summary -->
						<div class="col-md-3">
							<div class="card bg-light h-100">
								<div class="card-body text-center">
									<i class="bi bi-file-earmark-text text-primary" style="font-size: 2rem;"></i>
									<h3 class="mt-2 mb-0">{{ company_total_policies }}</h3>
									<p class="text-muted mb-1">Total Policies</p>
									<small class="text-success"><i class="bi bi-check-circle"></i> {{ company_active_policies }} Active</small>
								</div>
							</div>
						</div>
						<!-- Premium Summary -->
						<div class="col-md-3">
							<div class="card bg-light h-100">
								<div class="card-body text-center">
									<i class="bi bi-currency-exchange text-success" style="font-size: 2rem;"></i>
									<h3 class="mt-2 mb-0">KES {{ "{:,.0f}".format(company_total_premium) }}</h3>
									<p class="text-muted mb-0">Total Premium</p>
								</div>
							</div>
						</div>
						<!-- Claims Summary -->
						<div class="col-md-3">
							<div class="card bg-light h-100">
								<div class="card-body text-center">
									<i class="bi bi-file-earmark-medical text-warning" style="font-size: 2rem;"></i>
									<h3 class="mt-2 mb-0">{{ company_total_claims }}</h3>
									<p class="text-muted mb-1">Total Claims</p>
									<small class="text-success"><i class="bi bi-check-circle"></i> {{ company_approved_claims }} Approved</small>
								</div>
							</div>
						</div>
						<!-- Staff Summary -->
						<div class="col-md-3">
							<div class="card bg-light h-100">
								<div class="card-body text-center">
									<i class="bi bi-people text-info" style="font-size: 2rem;"></i>
									<h3 class="mt-2 mb-0">{{ company_total_staff }}</h3>
									<p class="text-muted mb-1">Staff Members</p>
									<small class="text-success"><i class="bi bi-check-circle"></i> {{ company_approved_staff }} Approved</small>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>

	<!-- Detailed Company Statistics -->
	<div class="row mb-4">
		<div class="col-lg-6 mb-3">
			<div class="card shadow-sm h-100">
				<div class="card-header bg-info text-white">
					<h5 class="mb-0"><i class="bi bi-file-earmark-text"></i> Policy Breakdown</h5>
				</div>
				<div class="card-body">
					<table class="table table-hover mb-0">
						<thead>
							<tr>
								<th>Status</th>
								<th class="text-end">Count</th>
								<th class="text-end">Percentage</th>
							</tr>
						</thead>
						<tbody>
							<tr>
								<td><span class="badge bg-success">Active</span></td>
								<td class="text-end">{{ company_active_policies }}</td>
								<td class="text-end">{{ "{:.1f}".format((company_active_policies / company_total_policies * 100) if company_total_policies else 0) }}%</td>
							</tr>
							<tr>
								<td><span class="badge bg-secondary">Expired</span></td>
								<td class="text-end">{{ company_expired_policies }}</td>
								<td class="text-end">{{ "{:.1f}".format((company_expired_policies / company_total_policies * 100) if company_total_policies else 0) }}%</td>
							</tr>
							<tr>
								<td><span class="badge bg-danger">Cancelled</span></td>
								<td class="text-end">{{ company_cancelled_policies }}</td>
								<td class="text-end">{{ "{:.1f}".format((company_cancelled_policies / company_total_policies * 100) if company_total_policies else 0) }}%</td>
							</tr>
							<tr class="table-primary fw-bold">
								<td>Total</td>
								<td class="text-end">{{ company_total_policies }}</td>
								<td class="text-end">100%</td>
							</tr>
						</tbody>
					</table>
				</div>
			</div>
		</div>

		<div class="col-lg-6 mb-3">
			<div class="card shadow-sm h-100">
				<div class="card-header bg-warning text-dark">
					<h5 class="mb-0"><i class="bi bi-file-earmark-medical"></i> Claims Breakdown</h5>
				</div>
				<div class="card-body">
					<table class="table table-hover mb-0">
						<thead>
							<tr>
								<th>Status</th>
								<th class="text-end">Count</th>
								<th class="text-end">Percentage</th>
							</tr>
						</thead>
						<tbody>
							<tr>
								<td><span class="badge bg-warning text-dark">Pending</span></td>
								<td class="text-end">{{ company_pending_claims }}</td>
								<td class="text-end">{{ "{:.1f}".format((company_pending_claims / company_total_claims * 100) if company_total_claims else 0) }}%</td>
							</tr>
							<tr>
								<td><span class="badge bg-info">Under Review</span></td>
								<td class="text-end">{{ company_under_review_claims }}</td>
								<td class="text-end">{{ "{:.1f}".format((company_under_review_claims / company_total_claims * 100) if company_total_claims else 0) }}%</td>
							</tr>
							<tr>
								<td><span class="badge bg-success">Approved</span></td>
								<td class="text-end">{{ company_approved_claims }}</td>
								<td class="text-end">{{ "{:.1f}".format((company_approved_claims / company_total_claims * 100) if company_total_claims else 0) }}%</td>
							</tr>
							<tr>
								<td><span class="badge bg-danger">Rejected</span></td>
								<td class="text-end">{{ company_rejected_claims }}</td>
								<td class="text-end">{{ "{:.1f}".format((company_rejected_claims / company_total_claims * 100) if company_total_claims else 0) }}%</td>
							</tr>
							<tr class="table-warning fw-bold">
								<td>Total</td>
								<td class="text-end">{{ company_total_claims }}</td>
								<td class="text-end">100%</td>
							</tr>
						</tbody>
					</table>
				</div>
			</div>
		</div>
	</div>

	<!-- Quotes Performance -->
	<div class="row mb-4">
		<div class="col-12">
			<div class="card shadow-sm">
				<div class="card-header bg-success text-white">
					<h5 class="mb-0"><i class="bi bi-file-earmark-text"></i> Quote Performance</h5>
				</div>
				<div class="card-body">
					<div class="row">
						<div class="col-md-3 text-center mb-3">
							<h4>{{ company_total_quotes }}</h4>
							<p class="text-muted mb-0">Total Quotes</p>
						</div>
						<div class="col-md-3 text-center mb-3">
							<h4>{{ company_sent_quotes }}</h4>
							<p class="text-muted mb-0">Sent</p>
						</div>
						<div class="col-md-3 text-center mb-3">
							<h4>{{ company_converted_quotes }}</h4>
							<p class="text-muted mb-0">Converted</p>
						</div>
						<div class="col-md-3 text-center mb-3">
							<h4 class="text-success">{{ "{:.1f}".format(company_quote_conversion_rate) }}%</h4>
							<p class="text-muted mb-0">Conversion Rate</p>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>

	<!-- Staff Activity -->
	<div class="row mb-4">
		<div class="col-12">
			<div class="card shadow-sm">
				<div class="card-header bg-secondary text-white">
					<h5 class="mb-0"><i class="bi bi-people"></i> Staff Activity - {{ user_company.name }}</h5>
				</div>
				<div class="card-body">
					<div class="table-responsive">
						<table class="table table-hover">
							<thead>
								<tr>
									<th>Username</th>
									<th>Email</th>
									<th class="text-center">Policies Created</th>
									<th class="text-center">Claims Processed</th>
									<th class="text-center">Quotes Generated</th>
								</tr>
							</thead>
							<tbody>
								{% for user in user_activity %}
								<tr {% if user.is_current %}class="table-primary"{% endif %}>
									<td>
										{{ user.username }}
										{% if user.is_current %}<span class="badge bg-primary ms-2">You</span>{% endif %}
									</td>
									<td>{{ user.email }}</td>
									<td class="text-center">{{ user.policies_created }}</td>
									<td class="text-center">{{ user.claims_processed }}</td>
									<td class="text-center">{{ user.quotes_generated }}</td>
								</tr>
								{% endfor %}
								{% if not user_activity %}
								<tr>
									<td colspan="5" class="text-center text-muted">No staff activity data available</td>
								</tr>
								{% endif %}
							</tbody>
						</table>
					</div>
				</div>
			</div>
		</div>
	</div>

	<!-- Industry Overview -->
	<div class="row mb-4">
		<div class="col-12">
			<div class="card shadow-sm border-info">
				<div class="card-header bg-info text-white">
					<h4 class="mb-0"><i class="bi bi-globe"></i> Industry Overview - Kenya Insurance Market</h4>
				</div>
				<div class="card-body">
					<div class="row g-3">
						<div class="col-md-3">
							<div class="card bg-light h-100">
								<div class="card-body text-center">
									<i class="bi bi-building text-info" style="font-size: 2rem;"></i>
									<h3 class="mt-2 mb-0">{{ industry_total_companies }}</h3>
									<p class="text-muted mb-0">Insurance Companies</p>
								</div>
							</div>
						</div>
						<div class="col-md-3">
							<div class="card bg-light h-100">
								<div class="card-body text-center">
									<i class="bi bi-file-earmark-text text-primary" style="font-size: 2rem;"></i>
									<h3 class="mt-2 mb-0">{{ industry_total_policies }}</h3>
									<p class="text-muted mb-1">Total Policies</p>
									<small class="text-success"><i class="bi bi-check-circle"></i> {{ industry_active_policies }} Active</small>
								</div>
							</div>
						</div>
						<div class="col-md-3">
							<div class="card bg-light h-100">
								<div class="card-body text-center">
									<i class="bi bi-currency-exchange text-success" style="font-size: 2rem;"></i>
									<h3 class="mt-2 mb-0">KES {{ "{:,.0f}".format(industry_total_premium / 1000000) }}M</h3>
									<p class="text-muted mb-0">Total Premium</p>
								</div>
							</div>
						</div>
						<div class="col-md-3">
							<div class="card bg-light h-100">
								<div class="card-body text-center">
									<i class="bi bi-people text-info" style="font-size: 2rem;"></i>
									<h3 class="mt-2 mb-0">{{ industry_total_insurers }}</h3>
									<p class="text-muted mb-0">Industry Professionals</p>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>

	<!-- Industry Detailed Statistics -->
	<div class="row mb-4">
		<div class="col-lg-6 mb-3">
			<div class="card shadow-sm h-100">
				<div class="card-header bg-primary text-white">
					<h5 class="mb-0"><i class="bi bi-pie-chart"></i> Industry Policies</h5>
				</div>
				<div class="card-body">
					<table class="table table-hover mb-0">
						<tbody>
							<tr>
								<td><strong>Total Policies:</strong></td>
								<td class="text-end">{{ industry_total_policies }}</td>
							</tr>
							<tr>
								<td>Active:</td>
								<td class="text-end">{{ industry_active_policies }} ({{ "{:.1f}".format((industry_active_policies / industry_total_policies * 100) if industry_total_policies else 0) }}%)</td>
							</tr>
							<tr>
								<td>Expired:</td>
								<td class="text-end">{{ industry_expired_policies }} ({{ "{:.1f}".format((industry_expired_policies / industry_total_policies * 100) if industry_total_policies else 0) }}%)</td>
							</tr>
							<tr>
								<td>Cancelled:</td>
								<td class="text-end">{{ industry_cancelled_policies }} ({{ "{:.1f}".format((industry_cancelled_policies / industry_total_policies * 100) if industry_total_policies else 0) }}%)</td>
							</tr>
							<tr class="table-primary">
								<td><strong>Total Premium:</strong></td>
								<td class="text-end"><strong>KES {{ "{:,.2f}".format(industry_total_premium) }}</strong></td>
							</tr>
						</tbody>
					</table>
				</div>
			</div>
		</div>

		<div class="col-lg-6 mb-3">
			<div class="card shadow-sm h-100">
				<div class="card-header bg-warning text-dark">
					<h5 class="mb-0"><i class="bi bi-bar-chart"></i> Industry Claims & Quotes</h5>
				</div>
				<div class="card-body">
					<table class="table table-hover mb-0">
						<tbody>
							<tr>
								<td><strong>Total Claims:</strong></td>
								<td class="text-end">{{ industry_total_claims }}</td>
							</tr>
							<tr>
								<td>Pending:</td>
								<td class="text-end">{{ industry_pending_claims }}</td>
							</tr>
							<tr>
								<td>Approved:</td>
								<td class="text-end">{{ industry_approved_claims }}</td>
							</tr>
							<tr>
								<td>Rejected:</td>
								<td class="text-end">{{ industry_rejected_claims }}</td>
							</tr>
							<tr class="table-warning">
								<td><strong>Quote Conversion Rate:</strong></td>
								<td class="text-end"><strong>{{ "{:.1f}".format(industry_quote_conversion_rate) }}%</strong></td>
							</tr>
						</tbody>
					</table>
				</div>
			</div>
		</div>
	</div>

	<!-- Company Rankings -->
	<div class="row mb-4">
		<div class="col-12">
			<div class="card shadow-sm">
				<div class="card-header bg-dark text-white">
					<h5 class="mb-0"><i class="bi bi-trophy"></i> Insurance Company Rankings</h5>
				</div>
				<div class="card-body">
					<div class="table-responsive">
						<table class="table table-hover">
							<thead>
								<tr>
									<th>#</th>
									<th>Company Name</th>
									<th class="text-center">Active Policies</th>
									<th class="text-end">Total Premium (KES)</th>
									<th class="text-center">Approved Claims</th>
									<th class="text-center">Staff Count</th>
								</tr>
							</thead>
							<tbody>
								{% for company in company_rankings %}
								<tr {% if company.is_current %}class="table-success"{% endif %}>
									<td>{{ loop.index }}</td>
									<td>
										{{ company.name }}
										{% if company.is_current %}<span class="badge bg-success ms-2">Your Company</span>{% endif %}
									</td>
									<td class="text-center">{{ company.active_policies }}</td>
									<td class="text-end">{{ "{:,.2f}".format(company.total_premium) }}</td>
									<td class="text-center">{{ company.approved_claims }}</td>
									<td class="text-center">{{ company.staff_count }}</td>
								</tr>
								{% endfor %}
							</tbody>
						</table>
					</div>
					<div class="alert alert-info mt-3 mb-0">
						<i class="bi bi-info-circle"></i> <strong>Note:</strong> Rankings are based on active policies count. Your company is highlighted in green.
					</div>
				</div>
			</div>
		</div>
	</div>
</div>
{% endblock %}
